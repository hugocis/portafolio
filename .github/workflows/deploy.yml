name: ğŸš€ Deploy to Invernalia Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸŒ Deploy to Production Server
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4
        
      - name: ï¿½ Test server connectivity
        run: |
          echo "ğŸ” Testing connectivity to server..."
          
          # Test DNS resolution
          nslookup herokku.duckdns.org || echo "âš ï¸ DNS resolution issue"
          
          # Test SSH port specifically
          echo "Testing SSH port 7122..."
          timeout 10s nc -z herokku.duckdns.org 7122 && echo "âœ… SSH port reachable" || echo "âŒ SSH port not reachable"
          
      - name: ï¿½ğŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: ğŸŒ Deploy to Invernalia Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: herokku.duckdns.org
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 7122
          timeout: 600s
          command_timeout: 1800s
          script: |
            set -e
            
            echo "ğŸ  Working directory: $(pwd)"
            echo "ğŸ‘¤ User: $(whoami)"
            echo "ğŸŒ Network connectivity test..."
            
            # Test basic connectivity
            ping -c 2 8.8.8.8 || echo "âš ï¸ Limited internet connectivity"
            
            # Crear directorio del proyecto si no existe
            PROJECT_DIR="portafolios"
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ğŸ“ Creating project directory..."
              mkdir -p "$PROJECT_DIR"
              cd "$PROJECT_DIR"
              echo "ğŸ“¦ Cloning repository..."
              git clone https://github.com/${{ github.repository }}.git .
            else
              echo "ğŸ“ Entering existing project directory..."
              cd "$PROJECT_DIR"
            fi
            
            # Verificar que es un repositorio git vÃ¡lido
            if [ ! -d ".git" ]; then
              echo "ğŸ”§ Initializing git repository..."
              rm -rf ./* ./.* 2>/dev/null || true
              git clone https://github.com/${{ github.repository }}.git .
            fi
            
            # Actualizar cÃ³digo con reintentos
            echo "ğŸ”„ Updating code from GitHub..."
            for i in {1..3}; do
              if git fetch origin && git reset --hard origin/main; then
                echo "âœ… Git update successful"
                break
              else
                echo "âš ï¸ Git update failed, attempt $i/3"
                sleep 5
              fi
            done
            git clean -fd
            
            # Crear archivo .env para el servidor
            echo "ğŸ“ Setting up environment configuration..."
            if [ ! -f .env ]; then
              if [ -f .env.server ]; then
                cp .env.server .env
              elif [ -f .env.example ]; then
                cp .env.example .env
              else
                touch .env
              fi
              
              # Configurar variables especÃ­ficas del servidor
              echo "" >> .env
              echo "NODE_ENV=production" >> .env
              echo "NEXTAUTH_URL=http://herokku.duckdns.org:8130" >> .env
              echo "DATABASE_URL=postgresql://postgres:postgres@db:5432/portafolios" >> .env
            fi
            
            # Verificar Docker
            echo "ğŸ³ Checking Docker..."
            docker --version || { echo "âŒ Docker not installed"; exit 1; }
            docker compose version || { echo "âŒ Docker Compose not available"; exit 1; }
            
            # Verificar conectividad de Docker
            echo "ğŸ” Testing Docker connectivity..."
            timeout 30s docker pull hello-world:latest || echo "âš ï¸ Docker registry connectivity issues detected"
            
            # Detener servicios existentes
            echo "ğŸ›‘ Stopping existing services..."
            docker compose -f docker-compose.yml -f docker-compose.server.yml down || echo "No services to stop"
            
            # Limpiar recursos con cuidado
            echo "ğŸ§¹ Cleaning up..."
            docker image prune -f || echo "Could not prune images"
            docker container prune -f || echo "Could not prune containers"
            
            # Estrategia de construcciÃ³n con reintentos
            echo "ğŸš€ Building and deploying with retry strategy..."
            
            # Intentar construcciÃ³n con timeout extendido
            export DOCKER_BUILDKIT=1
            export BUILDKIT_PROGRESS=plain
            
            for attempt in {1..3}; do
              echo "ğŸ”¨ Build attempt $attempt/3..."
              
              if timeout 1200s docker compose -f docker-compose.yml -f docker-compose.server.yml up -d --build; then
                echo "âœ… Build and deploy successful on attempt $attempt"
                break
              else
                echo "âŒ Build failed on attempt $attempt"
                if [ $attempt -lt 3 ]; then
                  echo "â³ Waiting 30 seconds before retry..."
                  docker compose -f docker-compose.yml -f docker-compose.server.yml down || true
                  sleep 30
                else
                  echo "ğŸ’¡ Trying fallback strategy: using pre-built images if available..."
                  
                  # Fallback: intentar sin --build si hay imÃ¡genes previas
                  if docker images | grep -q portafolios; then
                    echo "ğŸ“¦ Using existing images..."
                    docker compose -f docker-compose.yml -f docker-compose.server.yml up -d
                  else
                    echo "âŒ No fallback available"
                    exit 1
                  fi
                fi
              fi
            done
            
            # Esperar a que los servicios se inicien
            echo "â³ Waiting for services to start..."
            sleep 60
            
            # Verificar estado de los servicios
            echo "âœ… Final service status:"
            docker compose ps
            
            # Verificar que los contenedores estÃ¡n corriendo
            if ! docker compose ps | grep -q "Up"; then
              echo "âŒ No containers are running. Checking logs..."
              docker compose logs --tail=20
              exit 1
            fi
            
            # Mostrar logs recientes
            echo "ğŸ“‹ Recent application logs:"
            docker compose logs --tail=20 app || echo "Could not fetch app logs"
            
            # Test de conectividad de la aplicaciÃ³n con reintentos
            echo "ğŸ” Testing application health..."
            
            for i in {1..6}; do
              if curl -f -m 15 http://localhost:8130/api/health 2>/dev/null; then
                echo "âœ… Health check successful"
                break
              elif curl -f -m 15 http://localhost:8130 2>/dev/null; then
                echo "âœ… Main application responding"
                break
              else
                echo "â³ Health check attempt $i/6 failed, retrying in 10s..."
                if [ $i -eq 6 ]; then
                  echo "âš ï¸ Health checks failed, but deployment may still be successful"
                  echo "ğŸ” Port status:"
                  netstat -tlnp | grep :8130 || echo "Port 8130 not listening"
                  echo "ğŸ“‹ Container logs:"
                  docker compose logs --tail=10 app
                else
                  sleep 10
                fi
              fi
            done
            
            echo "ğŸ‰ Deployment process completed!"
            echo "ğŸŒ Application should be available at: http://herokku.duckdns.org:8130"
            echo "ğŸ” If not immediately available, the application may still be starting up"

  notify:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: ğŸ‰ Success Notification
        if: needs.deploy.result == 'success'
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Application URL: http://herokku.duckdns.org:8130"
          echo "ğŸ” Health check: http://herokku.duckdns.org:8130/api/health"
          
      - name: âŒ Failure Notification
        if: needs.deploy.result == 'failure'
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ” Check server connectivity and SSH credentials"
