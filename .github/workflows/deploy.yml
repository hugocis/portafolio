name: ğŸš€ Deploy to Invernalia Server

on:
  push:
    branches: [ main ]  # Cambiado de master a main (GitHub usa main por defecto ahora)
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

jobs:
  deploy:
    name: ğŸŒ Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: ğŸŒ Deploy to Invernalia Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: herokku.duckdns.org
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 7122
          script: |
            # Navegar al directorio del proyecto
            cd portafolios  # Cambia esto por el nombre real de tu directorio en el servidor
            
            # Actualizar cÃ³digo desde GitHub
            echo "ğŸ”„ Actualizando cÃ³digo desde GitHub..."
            git pull origin main
            
            # Detener contenedores actuales
            echo "ğŸ›‘ Deteniendo contenedores..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml down
            
            # Limpiar imÃ¡genes antiguas para ahorrar espacio
            echo "ğŸ§¹ Limpiando imÃ¡genes antiguas..."
            docker image prune -f
            
            # Construir y desplegar en modo producciÃ³n
            echo "ğŸš€ Desplegando en modo producciÃ³n..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
            
            # Verificar que los servicios estÃ©n funcionando
            echo "âœ… Verificando servicios..."
            docker compose ps
            
            # Mostrar logs recientes
            echo "ğŸ“‹ Logs recientes:"
            docker compose logs --tail=20 app

  # Job opcional para notificar el resultado
  notify:
    name: ğŸ“¢ Notify Deploy Status
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: ğŸ‰ Deploy Success
        if: needs.deploy.result == 'success'
        run: echo "âœ… Deploy completed successfully!"
        
      - name: âŒ Deploy Failed
        if: needs.deploy.result == 'failure'
        run: echo "âŒ Deploy failed! Check the logs above."
