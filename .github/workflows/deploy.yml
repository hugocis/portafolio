name: ğŸš€ Deploy to Invernalia Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸŒ Deploy to Production Server
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4
        
      - name: ï¿½ Test server connectivity
        run: |
          echo "ğŸ” Testing connectivity to server..."
          
          # Test DNS resolution
          nslookup herokku.duckdns.org || echo "âš ï¸ DNS resolution issue"
          
          # Test SSH port specifically
          echo "Testing SSH port 7122..."
          timeout 10s nc -z herokku.duckdns.org 7122 && echo "âœ… SSH port reachable" || echo "âŒ SSH port not reachable"
          
      - name: ï¿½ğŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: ğŸŒ Deploy to Invernalia Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: herokku.duckdns.org
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 7122
          timeout: 300s
          command_timeout: 900s
          script: |
            set -e
            
            echo "ğŸ  Working directory: $(pwd)"
            echo "ğŸ‘¤ User: $(whoami)"
            
            # Crear directorio del proyecto si no existe
            PROJECT_DIR="portafolios"
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ğŸ“ Creating project directory..."
              mkdir -p "$PROJECT_DIR"
              cd "$PROJECT_DIR"
              echo "ğŸ“¦ Cloning repository..."
              git clone https://github.com/${{ github.repository }}.git .
            else
              echo "ğŸ“ Entering existing project directory..."
              cd "$PROJECT_DIR"
            fi
            
            # Verificar que es un repositorio git vÃ¡lido
            if [ ! -d ".git" ]; then
              echo "ğŸ”§ Initializing git repository..."
              rm -rf ./* ./.* 2>/dev/null || true
              git clone https://github.com/${{ github.repository }}.git .
            fi
            
            # Actualizar cÃ³digo
            echo "ğŸ”„ Updating code from GitHub..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # Crear archivo .env para el servidor
            echo "ğŸ“ Setting up environment configuration..."
            if [ ! -f .env ]; then
              if [ -f .env.server ]; then
                cp .env.server .env
              elif [ -f .env.example ]; then
                cp .env.example .env
              else
                touch .env
              fi
              
              # Configurar variables especÃ­ficas del servidor
              echo "" >> .env
              echo "NODE_ENV=production" >> .env
              echo "NEXTAUTH_URL=http://herokku.duckdns.org:8130" >> .env
              echo "DATABASE_URL=postgresql://postgres:postgres@db:5432/portafolios" >> .env
            fi
            
            # Verificar Docker
            echo "ğŸ³ Checking Docker..."
            docker --version || { echo "âŒ Docker not installed"; exit 1; }
            docker compose version || { echo "âŒ Docker Compose not available"; exit 1; }
            
            # Detener servicios existentes
            echo "ğŸ›‘ Stopping existing services..."
            docker compose -f docker-compose.yml -f docker-compose.server.yml down || echo "No services to stop"
            
            # Limpiar recursos
            echo "ğŸ§¹ Cleaning up..."
            docker image prune -f || echo "Could not prune images"
            
            # Construir y desplegar con configuraciÃ³n especÃ­fica del servidor
            echo "ğŸš€ Deploying with server configuration..."
            docker compose -f docker-compose.yml -f docker-compose.server.yml up -d --build
            
            # Esperar a que los servicios se inicien
            echo "â³ Waiting for services..."
            sleep 45
            
            # Verificar estado
            echo "âœ… Service status:"
            docker compose ps
            
            # Mostrar logs recientes
            echo "ğŸ“‹ Recent logs:"
            docker compose logs --tail=15 app || echo "Could not fetch logs"
            
            # Test de aplicaciÃ³n
            echo "ğŸ” Testing application..."
            curl -f -m 10 http://localhost:8130/api/health 2>/dev/null && echo "âœ… Health check OK" || echo "âš ï¸ App may still be starting"
            
            echo "ğŸ‰ Deployment completed!"
            echo "ğŸŒ App URL: http://herokku.duckdns.org:8130"

  notify:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: ğŸ‰ Success Notification
        if: needs.deploy.result == 'success'
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Application URL: http://herokku.duckdns.org:8130"
          echo "ğŸ” Health check: http://herokku.duckdns.org:8130/api/health"
          
      - name: âŒ Failure Notification
        if: needs.deploy.result == 'failure'
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ” Check server connectivity and SSH credentials"
