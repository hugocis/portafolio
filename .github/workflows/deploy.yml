name: ðŸš€ Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: ðŸŒ Deploy Application
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4
          
      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: ðŸš€ Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP || 'herokku.duckdns.org' }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 7122
          timeout: 600s
          command_timeout: 1800s
          script: |
            set -e
            
            echo "ðŸ  $(whoami)@$(hostname)"
            
            # Crear o actualizar directorio del proyecto
            PROJECT_DIR="portafolios"
            [ ! -d "$PROJECT_DIR" ] && mkdir -p "$PROJECT_DIR" && cd "$PROJECT_DIR" && git clone https://github.com/${{ github.repository }}.git . || cd "$PROJECT_DIR"
            
            # Actualizar cÃ³digo
            echo "ðŸ”„ Updating code..."
            git config --global --add safe.directory $(pwd)
            git fetch origin && git reset --hard origin/main && git clean -fd || echo "âš ï¸ Git update had issues"
            
            # Configurar ambiente
            echo "ðŸ“ Configuring environment..."
            cat > .env << EOF
            NODE_ENV=production
            PORT=3000
            NEXTAUTH_URL=https://herokku.duckdns.org
            DATABASE_URL=postgresql://postgres:${{ secrets.POSTGRES_PASSWORD }}@db:5432/portafolios
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            POSTGRES_USER=postgres
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DB=portafolios
            OAUTH_GITHUB_ID=${{ secrets.OAUTH_GITHUB_ID }}
            OAUTH_GITHUB_SECRET=${{ secrets.OAUTH_GITHUB_SECRET }}
            CLOUDFLARE_TUNNEL_TOKEN=${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
            LOG_LEVEL=info
            ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
            ENCRYPTION_IV=${{ secrets.ENCRYPTION_IV }}
            CRON_SECRET_TOKEN=${{ secrets.CRON_SECRET_TOKEN }}
            EOF
            
            # Detener servicios y limpiar
            echo "ðŸ›‘ Stopping existing services..."
            docker compose -f docker-compose.yml -f docker-compose.server.yml down 2>/dev/null || true
            docker image prune -f 2>/dev/null || true
            
            # Desplegar
            echo "ðŸš€ Deploying..."
            export DOCKER_BUILDKIT=1
            
            if docker compose -f docker-compose.yml -f docker-compose.server.yml up -d --build 2>&1 | tee /tmp/deploy.log; then
              echo "âœ… Build successful"
            elif [ -f "Dockerfile.stable" ]; then
              echo "âš ï¸ Trying with stable Dockerfile..."
              cp Dockerfile Dockerfile.backup && cp Dockerfile.stable Dockerfile
              docker compose -f docker-compose.yml -f docker-compose.server.yml up -d --build || exit 1
            else
              echo "âŒ Deployment failed"
              docker compose logs --tail=20
              exit 1
            fi
            
            # Esperar inicializaciÃ³n
            echo "â³ Waiting for services (60s)..."
            sleep 60
            
            # Verificar salud
            echo "ðŸ” Testing application..."
            for i in {1..6}; do
              if curl -f -m 10 http://localhost:8130/api/health 2>/dev/null; then
                echo "âœ… Application is healthy"
                break
              else
                [ $i -lt 6 ] && echo "â³ Waiting... ($i/6)" && sleep 10
              fi
            done
            
            # Obtener URL de Cloudflare Quick Tunnel
            echo ""
            echo "ðŸ” Getting Cloudflare URL..."
            sleep 5  # Esperar a que cloudflared genere la URL
            CLOUDFLARE_URL=$(docker compose logs cloudflared 2>/dev/null | grep -oP 'https://[a-z0-9-]+\.trycloudflare\.com' | head -1)
            
            # InformaciÃ³n final
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸŽ‰ Deployment Completed!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ðŸŒ Access URLs:"
            echo "   â€¢ HTTPS (Primary):  https://herokku.duckdns.org"
            echo "   â€¢ HTTP (Direct):    http://herokku.duckdns.org:8130"
            if [ -n "$CLOUDFLARE_URL" ]; then
              echo "   â€¢ Cloudflare:       $CLOUDFLARE_URL"
            fi
            echo ""
            echo "ðŸ“Š Container Status:"
            docker compose ps --format "table {{.Name}}\t{{.Status}}"
            echo ""
            
            # Guardar la URL de Cloudflare para el siguiente step
            if [ -n "$CLOUDFLARE_URL" ]; then
              echo "$CLOUDFLARE_URL" > /tmp/cloudflare_url.txt
            fi

      - name: ðŸ“Š Get Cloudflare URL
        id: get_url
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP || 'herokku.duckdns.org' }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 7122
          script: |
            cd portafolios
            
            # Verificar si cloudflared estÃ¡ corriendo
            echo "ðŸ” Checking cloudflared status..."
            docker compose ps cloudflared || echo "âš ï¸ Cloudflared container not found"
            
            # Intentar obtener la URL con mÃºltiples reintentos
            echo "ðŸ” Attempting to get Cloudflare URL..."
            for i in {1..5}; do
              sleep 5
              
              # Intentar con diferentes mÃ©todos
              CLOUDFLARE_URL=$(docker compose logs cloudflared 2>/dev/null | grep -oP 'https://[a-z0-9-]+\.trycloudflare\.com' | tail -1)
              
              # Si no funciona, intentar con docker logs directo
              if [ -z "$CLOUDFLARE_URL" ]; then
                CONTAINER_ID=$(docker ps -qf "name=cloudflared")
                if [ -n "$CONTAINER_ID" ]; then
                  CLOUDFLARE_URL=$(docker logs "$CONTAINER_ID" 2>&1 | grep -oP 'https://[a-z0-9-]+\.trycloudflare\.com' | tail -1)
                fi
              fi
              
              if [ -n "$CLOUDFLARE_URL" ]; then
                echo "cloudflare_url=$CLOUDFLARE_URL" >> $GITHUB_OUTPUT
                echo "âœ… Cloudflare URL found (attempt $i/5): $CLOUDFLARE_URL"
                break
              else
                echo "â³ Attempt $i/5 - URL not available yet..."
                if [ $i -eq 5 ]; then
                  echo "âš ï¸ Could not retrieve Cloudflare URL after 5 attempts"
                  echo "ðŸ’¡ The Quick Tunnel may take longer to initialize"
                  echo "ðŸ“‹ Recent cloudflared logs:"
                  docker compose logs --tail=15 cloudflared 2>/dev/null || echo "No logs available"
                fi
              fi
            done
            
      - name: ðŸŽ‰ Deployment Summary
        if: success()
        run: |
          echo "### âœ… Deployment Successful! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸŒ Access URLs:" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| **Primary (HTTPS)** | https://herokku.duckdns.org |" >> $GITHUB_STEP_SUMMARY
          echo "| **Direct (HTTP)** | http://herokku.duckdns.org:8130 |" >> $GITHUB_STEP_SUMMARY
          echo "| **Health Check** | https://herokku.duckdns.org/api/health |" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.get_url.outputs.cloudflare_url }}" ]; then
            echo "| **ðŸŒ©ï¸ Cloudflare Quick Tunnel** | ${{ steps.get_url.outputs.cloudflare_url }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> **Note:** Cloudflare Quick Tunnel URL not available yet. Check the deployment logs or wait a few more minutes." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ”’ Security:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SSL/HTTPS enabled via Cloudflare Tunnel" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Environment variables configured" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Database encrypted connections" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“¦ Deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **Your portfolio is now live!**" >> $GITHUB_STEP_SUMMARY
